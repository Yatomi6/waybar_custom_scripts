#!/usr/bin/env python3
import http.server
import json
import os
import socketserver
import subprocess
import sys
from urllib.parse import urlparse

HOME = os.path.expanduser("~")
UI_DIR = os.environ.get("TYPER_STATS_UI", os.path.join(HOME, "ttyper_custom", "stats-ui"))
DATA_FILE = os.environ.get(
    "TYPER_STATS_FILE",
    os.path.join(HOME, ".local", "share", "ttyper", "stats.json"),
)

DEFAULT_STATS = {
    "version": 1,
    "updated_at": 0,
    "totals": {
        "tests": 0,
        "words_typed": 0,
        "words_correct": 0,
        "words_with_errors": 0,
        "words_incorrect": 0,
        "error_keystrokes": 0,
    },
    "words": {},
}


def load_stats():
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as fh:
            return json.load(fh)
    except Exception:
        return DEFAULT_STATS


class Handler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=UI_DIR, **kwargs)

    def do_GET(self):
        path = urlparse(self.path).path
        if path == "/stats.json":
            payload = json.dumps(load_stats()).encode("utf-8")
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.send_header("Cache-Control", "no-store")
            self.send_header("Content-Length", str(len(payload)))
            self.end_headers()
            self.wfile.write(payload)
            return
        super().do_GET()

    def log_message(self, *_args):
        return


class ThreadingServer(socketserver.ThreadingMixIn, socketserver.TCPServer):
    allow_reuse_address = True


def main():
    if not os.path.isdir(UI_DIR):
        print(f"UI directory not found: {UI_DIR}", file=sys.stderr)
        return 1

    with ThreadingServer(("127.0.0.1", 0), Handler) as httpd:
        port = httpd.server_address[1]
        url = f"http://127.0.0.1:{port}/"
        try:
            subprocess.Popen(["xdg-open", url], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        except Exception:
            print(f"Open this URL in your browser: {url}", flush=True)
        print(f"TTyper stats running at {url}", flush=True)
        httpd.serve_forever()
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
