#!/usr/bin/env python3
import http.server
import json
import os
import socketserver
import subprocess
import sys
import time
from urllib.parse import urlparse

HOME = os.path.expanduser("~")
UI_DIR = os.environ.get("INPUT_STATS_UI", os.path.join(HOME, "rice", "input-stats-ui"))
DATA_FILE = os.environ.get(
    "INPUT_STATS_FILE",
    os.path.join(HOME, ".local", "state", "ags", "input-counts.json"),
)
COLS = int(os.environ.get("INPUT_STATS_COLS", "96"))
ROWS = int(os.environ.get("INPUT_STATS_ROWS", "54"))


def default_heatmap():
    return [0 for _ in range(COLS * ROWS)]


DEFAULT_STATS = {
    "version": 1,
    "updated_at": 0,
    "date": "",
    "startedAt": int(time.time() * 1000),
    "screenWidth": 0,
    "screenHeight": 0,
    "left": 0,
    "right": 0,
    "leftMouse": 0,
    "rightMouse": 0,
    "leftPad": 0,
    "rightPad": 0,
    "keys": 0,
    "scrollUp": 0,
    "scrollDown": 0,
    "scrollLeft": 0,
    "scrollRight": 0,
    "distancePx": 0,
    "clickHeatmapLeft": default_heatmap(),
    "clickHeatmapRight": default_heatmap(),
    "keyCounts": {},
}


def normalize_stats(data):
    stats = dict(DEFAULT_STATS)
    if not isinstance(data, dict):
        return stats

    stats.update({k: data.get(k, stats[k]) for k in stats.keys()})

    for key in [
        "screenWidth",
        "screenHeight",
        "left",
        "right",
        "leftMouse",
        "rightMouse",
        "leftPad",
        "rightPad",
        "keys",
        "scrollUp",
        "scrollDown",
        "scrollLeft",
        "scrollRight",
        "distancePx",
    ]:
        try:
            stats[key] = float(stats[key]) if "scroll" in key or key == "distancePx" else int(stats[key])
        except Exception:
            stats[key] = 0

    for heat_key in ["clickHeatmapLeft", "clickHeatmapRight"]:
        value = data.get(heat_key)
        if isinstance(value, list) and len(value) == COLS * ROWS:
            stats[heat_key] = [int(v) if str(v).isdigit() else 0 for v in value]
        else:
            stats[heat_key] = default_heatmap()

    if not isinstance(stats.get("keyCounts"), dict):
        stats["keyCounts"] = {}

    return stats


def load_stats():
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as fh:
            data = json.load(fh)
    except Exception:
        data = {}

    stats = normalize_stats(data)
    try:
        stats["updated_at"] = int(os.path.getmtime(DATA_FILE))
    except Exception:
        stats["updated_at"] = int(time.time())
    return stats


class Handler(http.server.SimpleHTTPRequestHandler):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, directory=UI_DIR, **kwargs)

    def do_GET(self):
        path = urlparse(self.path).path
        if path == "/stats.json":
            payload = json.dumps(load_stats()).encode("utf-8")
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.send_header("Cache-Control", "no-store")
            self.send_header("Content-Length", str(len(payload)))
            self.end_headers()
            self.wfile.write(payload)
            return
        super().do_GET()

    def log_message(self, *_args):
        return


class ThreadingServer(socketserver.ThreadingMixIn, socketserver.TCPServer):
    allow_reuse_address = True


def main():
    if not os.path.isdir(UI_DIR):
        print(f"UI directory not found: {UI_DIR}", file=sys.stderr)
        return 1

    with ThreadingServer(("127.0.0.1", 0), Handler) as httpd:
        port = httpd.server_address[1]
        url = f"http://127.0.0.1:{port}/"
        try:
            subprocess.Popen(["xdg-open", url], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        except Exception:
            print(f"Open this URL in your browser: {url}", flush=True)
        print(f"Input stats running at {url}", flush=True)
        httpd.serve_forever()
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
